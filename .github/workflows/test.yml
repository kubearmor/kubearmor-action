name: test

on:
  push:
    branches: [main,dev]
  pull_request:
    branches: [main,dev]
permissions:
    pull-requests: write
    contents: write

jobs:
  test_job:
    runs-on: ubuntu-latest
    name: A job to test kubearmor-action
    steps:
      - name: kubearmor-action test
        id: visualisation-report
        uses: zhy76/kubearmor-action@dev
        with:
          old-app: 'https://raw.githubusercontent.com/kubearmor/KubeArmor/main/examples/wordpress-mysql/wordpress-mysql-deployment.yaml'
          new-app: 'manifests/app.yaml'
          namespace: 'wordpress-mysql'
          app-name: 'wordpress'
      - uses: actions/download-artifact@v2
        with:
          name: ${{ steps.visualisation-report.outputs.visualisation-results-artifact }}
          path: images
      - uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./images
          keep_files: true
      - name: comment PR
        run: |
          gh pr comment  ${{ github.event.number }} -b"![system_graph](https://raw.githubusercontent.com/${{ github.repository }}/gh-pages/${{ steps.visualisation-report.outputs.sys-visualisation-image }})"
          gh pr comment  ${{ github.event.number }} -b"![network_graph](https://raw.githubusercontent.com/${{ github.repository }}/gh-pages/${{ steps.visualisation-report.outputs.network-visualisation-image }})"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
