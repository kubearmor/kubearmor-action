# SPDX-License-Identifier: Apache-2.0
# Copyright 2023 Authors of KubeArmor

name: 'install kubearmor'
description: 'install kubearmor'
runs:
  using: composite
  steps:
    # Install kubearmor     
    - name: Download required dependencies
      run: sudo apt-get install -y socat
      shell: bash
    - name: Setup a Kubernetes environment
      run: ./hack/install-k3s.sh
      shell: bash
    - name: Test connectivity
      run: kubectl get no
      shell: bash
    - name: Install karmor
      run: curl -sfL http://get.kubearmor.io/ | sudo sh -s -- -b /usr/local/bin && karmor install
      shell: bash
    - name: Install Discovery-engine
      run: kubectl apply -f https://raw.githubusercontent.com/kubearmor/discovery-engine/dev/deployments/k8s/deployment.yaml
      shell: bash
    - name: Install Cilium
      run: |
        CILIUM_CLI_VERSION=$(curl -s https://raw.githubusercontent.com/cilium/cilium-cli/master/stable.txt)
        CLI_ARCH=amd64
        if [ "$(uname -m)" = "aarch64" ]; then CLI_ARCH=arm64; fi
        curl -L --fail --remote-name-all https://github.com/cilium/cilium-cli/releases/download/${CILIUM_CLI_VERSION}/cilium-linux-${CLI_ARCH}.tar.gz{,.sha256sum}
        sha256sum --check cilium-linux-${CLI_ARCH}.tar.gz.sha256sum
        tar xzvfC cilium-linux-${CLI_ARCH}.tar.gz /usr/local/bin
        rm cilium-linux-${CLI_ARCH}.tar.gz{,.sha256sum}
        cilium install
      shell: bash